import{r as n,u as ne,j as e,a as L,S as le}from"./index-C3edZBvR.js";import{c as oe,A as ie}from"./aiService-BE1pcnuv.js";import{i as ce,g as de,s as xe}from"./database-CGTBBJr-.js";import{F as ue}from"./FileUpload-VNhAmH-W.js";import{R as he}from"./ResultView-_dusQHX8.js";import{e as ge}from"./textExtractorService-Dks41_ry.js";import"https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs";import"./settingsService-p0j8CqeW.js";const Ce=({document:i,onNavigateToService:U})=>{const[h,E]=n.useState(null),[c,d]=n.useState(!1),[F,x]=n.useState(""),[j,g]=n.useState(""),[D,v]=n.useState([]),[r,f]=n.useState(null),[k,m]=n.useState([]),[u,p]=n.useState(1),[q,O]=n.useState(!1),[b,R]=n.useState(1.5),[J,P]=n.useState(!1),T=n.useRef(null),{setInterruptedTask:Q,setStagedFile:Y}=ne(),V=.5,W=3,X=.25;n.useEffect(()=>{ce()},[]);const ee=(t,a)=>`view-doc-${a}-${t.name}-${t.size}-${t.lastModified}`,K=t=>{const a=[];return t.forEach((s,l)=>{s.type==="heading"&&a.push({title:s.content,id:`heading-${l}`})}),a},_=n.useCallback(async t=>{if(!(!r||!T.current)){d(!0);try{const a=await r.getPage(t),s=a.getViewport({scale:b}),l=T.current,o=l.getContext("2d");l.height=s.height,l.width=s.width,o&&await a.render({canvasContext:o,viewport:s}).promise,p(t)}catch{g("فشل عرض الصفحة.")}finally{d(!1)}}},[r,b]),H=async t=>{g(""),v([]),f(null),m([]),p(1),O(!1),P(!1),d(!0),x("جاري قراءة الملف الأولي...");const a=ee(t,"analysis");try{const s=await de(a);if(s){if(console.log("Loading analysis from cache..."),v(s.outline),s.structuredContent&&m(s.structuredContent),t.type==="application/pdf"&&!s.structuredContent){const l=window.PDFLib,o=window.pdfjsLib;if(!l)throw new Error("مكتبة PDFLib لم يتم تحميلها.");if(!o)throw new Error("مكتبة PDF.js لم يتم تحميلها.");const{PDFDocument:y}=l,C=await t.arrayBuffer();x("جاري إصلاح بنية المستند...");let N;try{const A=await y.load(C,{ignoreEncryption:!0}),S=await y.create();(await S.copyPages(A,A.getPageIndices())).forEach(w=>S.addPage(w));try{const w=S.getForm();w.getFields().length>0&&w.flatten()}catch{}N=await S.save()}catch{throw new Error("فشل في معالجة ملف PDF. قد يكون الملف تالفًا أو غير متوافق.")}const re=await o.getDocument({data:N,verbosity:1}).promise;f(re)}d(!1),x("");return}}catch(s){if(s.message.includes("فشل في معالجة ملف PDF")){g(s.message),d(!1);return}console.warn("Could not read analysis cache.",s)}try{const s=await ge(t,x);if(!s.trim())if(t.type==="application/pdf"){P(!0),d(!1),x("");return}else throw new Error("المستند يبدو فارغًا.");x("تم استخراج النص، جاري الآن إنشاء الفهرس الذكي...");const l=await oe(s),o=K(l);m(l),f(null),await xe(a,{outline:o,structuredContent:l})}catch(s){s instanceof ie?Q({serviceId:"view",resume:()=>H(t),context:{file:t}}):(g(s.message||"حدث خطأ أثناء معالجة الملف."),f(null),m([]))}finally{d(!1),x("")}},I=n.useCallback(()=>{r&&p(t=>Math.max(1,t-1))},[r]),M=n.useCallback(()=>{r&&p(t=>Math.min(r.numPages,t-1))},[r]),$=n.useCallback(()=>{R(t=>Math.min(W,t+X))},[]),B=n.useCallback(()=>{R(t=>Math.max(V,t-X))},[]);n.useEffect(()=>{const t=a=>{if(!r||a.target instanceof HTMLInputElement||a.target instanceof HTMLTextAreaElement)return;let s=!1;switch(a.key){case"ArrowRight":M(),s=!0;break;case"ArrowLeft":I(),s=!0;break;case"+":case"=":$(),s=!0;break;case"-":B(),s=!0;break}s&&a.preventDefault()};return window.addEventListener("keydown",t),()=>{window.removeEventListener("keydown",t)}},[r,M,I,$,B]),n.useEffect(()=>{i&&(E({name:i.name}),m(i.content),v(K(i.content)),O(!!i.id))},[i]),n.useEffect(()=>{r&&!i&&_(u)},[r,u,_,i]);const te=t=>{if(t.length>0){const a=t[0];["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain"].includes(a.type)?(E(a),H(a)):g("نوع الملف غير مدعوم. الرجاء اختيار PDF, DOCX, أو TXT.")}},Z=t=>{r&&t.page?p(t.page):t.id&&window.document.getElementById(t.id)?.scrollIntoView({behavior:"smooth",block:"start"})},se=()=>{const t=le.find(a=>a.id==="pdf-tools");if(t&&h){const a=Object.assign(h,{context:{nextServiceId:"extract-text-from-pdf"}});Y(a),U(t)}},z=()=>k.map((t,a)=>{if(t.type==="heading"){const l=`h${Math.max(1,Math.min(6,t.level||2))}`;return e.jsx(l,{id:`heading-${a}`,children:t.content},a)}return e.jsx("p",{children:t.content},a)}),G=()=>{E(null),f(null),m([]),v([]),g(""),P(!1)},ae=r||k.length>0;return J?e.jsxs("div",{className:"max-w-3xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg text-center",children:[e.jsx("div",{className:"mx-auto text-amber-500 mb-4 h-16 w-16 flex items-center justify-center rounded-full bg-amber-100 dark:bg-amber-900/50",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-800 dark:text-slate-100 mb-4",children:"مستند مصور"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 mb-6",children:'لا يحتوي هذا الملف على نص قابل للاستخراج مباشرة. لاستخراج النص منه، يرجى استخدام أداة "استخراج النص من PDF" المخصصة لذلك.'}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx("button",{onClick:G,className:"px-6 py-2 bg-slate-200 text-slate-800 dark:bg-slate-700 dark:text-slate-200 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600",children:"اختيار ملف آخر"}),e.jsx("button",{onClick:se,className:"px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700",children:"الذهاب إلى أداة الاستخراج"})]})]}):!h&&!i?e.jsx("div",{className:"bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg max-w-3xl mx-auto",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(ue,{onFileSelect:te,acceptedFileTypes:".pdf,.docx,.txt",promptText:"اختر ملف (PDF, DOCX, TXT) لعرضه"}),c&&e.jsxs("div",{className:"mt-4 flex flex-col items-center gap-2",children:[e.jsx(L,{}),e.jsx("p",{children:F||"جاري تحليل المستند..."})]}),j&&e.jsx("p",{className:"mt-4 text-red-500 bg-red-100 dark:bg-red-900/50 dark:text-red-300 p-3 rounded-md w-full text-center",children:j})]})}):k.length>0&&!r?e.jsx(he,{title:`محتويات: ${h?.name}`,onReset:G,canSaveToLibrary:!q,structuredContent:k,fileName:h?.name,fileType:h?.type,documentType:"original",children:e.jsx("div",{className:"w-full h-[70vh] overflow-y-auto p-6 text-right prose prose-slate dark:prose-invert max-w-none bg-slate-50 dark:bg-slate-900 rounded-md",children:z()})}):e.jsx("div",{className:"max-w-7xl mx-auto",children:!ae&&c?e.jsx("div",{className:"bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg max-w-3xl mx-auto",children:e.jsxs("div",{className:"flex flex-col items-center",children:[c&&e.jsxs("div",{className:"mt-4 flex flex-col items-center gap-2",children:[e.jsx(L,{}),e.jsx("p",{children:F||"جاري تحليل المستند..."})]}),j&&e.jsx("p",{className:"mt-4 text-red-500 bg-red-100 dark:bg-red-900/50 dark:text-red-300 p-3 rounded-md w-full text-center",children:j})]})}):e.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[e.jsxs("aside",{className:"md:w-1/3 lg:w-1/4 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg h-full md:sticky top-8",role:"region","aria-labelledby":"outline-heading",children:[e.jsx("h3",{id:"outline-heading",className:"text-xl font-bold mb-4 border-b dark:border-slate-600 pb-2",children:"فهرس المحتويات"}),c&&!D.length?e.jsx("div",{className:"flex justify-center items-center p-4",children:e.jsx(L,{})}):D.length>0?e.jsx("nav",{"aria-label":"التنقل في المستند",children:e.jsx("ul",{className:"space-y-2 max-h-[70vh] overflow-y-auto",children:D.map((t,a)=>{const s=!r&&t.id,l=e.jsxs(e.Fragment,{children:[t.title,r&&t.page&&e.jsxs("span",{className:"text-sm text-slate-500 dark:text-slate-400 mr-2",children:["(ص. ",t.page,")"]})]}),o="w-full text-right p-2 rounded transition-colors text-slate-700 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800",y="bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-bold",C="hover:bg-slate-100 dark:hover:bg-slate-700";return e.jsx("li",{children:s?e.jsx("a",{href:`#${t.id}`,onClick:N=>{N.preventDefault(),Z(t)},className:`${o} ${C} block`,children:l}):e.jsx("button",{onClick:()=>Z(t),className:`${o} ${u===t.page&&r?y:C}`,"aria-current":u===t.page&&r?"page":void 0,children:l})},a)})})}):e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:"لم يتمكن الذكاء الاصطناعي من إنشاء فهرس لهذا المستند."})]}),e.jsxs("main",{className:"flex-1 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg min-w-0",role:"region","aria-labelledby":"document-main-content-heading",children:[e.jsx("h2",{id:"document-main-content-heading",className:"sr-only",children:"محتوى المستند"}),r&&e.jsxs("div",{className:"flex justify-between items-center mb-4 border-b dark:border-slate-600 pb-2 flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:I,disabled:u<=1||c,className:"p-2 bg-slate-200 dark:bg-slate-700 rounded disabled:opacity-50 hover:bg-slate-300 dark:hover:bg-slate-600","aria-label":"الصفحة السابقة",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"transform scale-x-[-1]",children:[e.jsx("path",{d:"M5 12h14"}),e.jsx("path",{d:"m12 5 7 7-7 7"})]})}),e.jsxs("span",{className:"font-mono text-sm","aria-live":"polite","aria-atomic":"true",children:["صفحة ",u," من ",r.numPages]}),e.jsx("button",{onClick:M,disabled:u>=r.numPages||c,className:"p-2 bg-slate-200 dark:bg-slate-700 rounded disabled:opacity-50 hover:bg-slate-300 dark:hover:bg-slate-600","aria-label":"الصفحة التالية",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M5 12h14"}),e.jsx("path",{d:"m12 5 7 7-7 7"})]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:B,disabled:b<=V,className:"p-2 bg-slate-200 dark:bg-slate-700 rounded disabled:opacity-50 hover:bg-slate-300 dark:hover:bg-slate-600","aria-label":"تصغير",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]})}),e.jsxs("span",{className:"font-mono text-sm w-16 text-center","aria-live":"polite",children:[Math.round(b*100),"%"]}),e.jsx("button",{onClick:$,disabled:b>=W,className:"p-2 bg-slate-200 dark:bg-slate-700 rounded disabled:opacity-50 hover:bg-slate-300 dark:hover:bg-slate-600","aria-label":"تكبير",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),e.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]})})]})]}),e.jsx("div",{className:"overflow-auto max-h-[75vh] flex justify-center items-start",children:c?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(L,{}),e.jsx("p",{className:"mt-2",children:F})]}):r?e.jsx("canvas",{ref:T}):e.jsx("div",{className:"w-full text-right prose prose-slate dark:prose-invert max-w-none p-4",children:z()})})]})]})})};export{Ce as default};
