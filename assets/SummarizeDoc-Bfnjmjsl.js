import{r as a,u as Y,j as t,a as Z}from"./index-C3edZBvR.js";import{s as ee,a as te,A as H,b as ae}from"./aiService-BE1pcnuv.js";import{F as se}from"./FileUpload-VNhAmH-W.js";import{R as re}from"./ResultView-_dusQHX8.js";import{C as le}from"./ConfirmationModal-DvLumpuQ.js";import{e as oe}from"./textExtractorService-Dks41_ry.js";import{n as T}from"./notificationService-43TODkn5.js";import{g as ne}from"./settingsService-p0j8CqeW.js";import"https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs";import"./database-CGTBBJr-.js";const ve=({onSelectService:ie})=>{const[o,w]=a.useState(null),[S,g]=a.useState(!1),[C,u]=a.useState(""),[R,n]=a.useState(""),[$,l]=a.useState(""),[x,y]=a.useState("points"),{setInterruptedTask:z,interruptedTask:V,clearInterruptedTask:_,stagedFile:F,setStagedFile:A}=Y(),N=a.useRef(null),[M,P]=a.useState(!1),[D,E]=a.useState(null),[I,q]=a.useState([]),[c,b]=a.useState("");a.useEffect(()=>{q(ne().filter(e=>e.type==="summary"))},[]),a.useEffect(()=>{F&&(O([F]),A(null))},[F,A]);const U=async(e,i)=>{g(!0),n(""),l("الملف قائم على الصور، جاري استخراج الصور (هذا قد يستغرق وقتاً)...");try{const s=window.pdfjsLib;if(!s)throw new Error("مكتبة PDF.js لم يتم تحميلها. يرجى تحديث الصفحة.");if(!N.current)throw new Error("Canvas element is not available for image extraction.");const r=N.current,m=r.getContext("2d");if(!m)throw new Error("Canvas context is not available.");const v=await e.arrayBuffer(),h=await s.getDocument({data:v,verbosity:1}).promise,d=[],k=100,p=h.numPages,j=Math.min(p,k);p>k&&(l(`الملف كبير جداً، سيتم تلخيص أول ${k} صفحة فقط.`),await new Promise(f=>setTimeout(f,2500)));for(let f=1;f<=j;f++){l(`جاري معالجة صورة الصفحة ${f} من ${j}...`);const B=await h.getPage(f),L=B.getViewport({scale:2});r.height=L.height,r.width=L.width,await B.render({canvasContext:m,viewport:L}).promise;const W=r.toDataURL("image/jpeg",.9).split(",")[1];d.push({inlineData:{data:W,mimeType:"image/jpeg"}})}if(d.length===0)throw new Error("لم يتم العثور على صفحات قابلة للمعالجة في ملف PDF.");l("جاري تلخيص الصور...");const Q=await ae(d,i);u(Q),T("✅ اكتمل تلخيص المستند!",{body:`تم تلخيص ملفك "${e.name}" بنجاح.`})}catch(s){s instanceof H?z({serviceId:"summarize-as-images",resume:()=>U(e,i),context:{}}):(n(s.message||"حدث خطأ غير متوقع أثناء معالجة الصور."),w(null),T("❌ فشل تلخيص المستند",{body:`حدث خطأ أثناء تلخيص ملفك "${e.name}".`}))}finally{g(!1),l("")}},G=()=>{D&&U(D.file,D.summaryType),P(!1),E(null)},X=async(e,i)=>{if(!e){n("الرجاء اختيار ملف أولاً.");return}g(!0),n(""),u(""),l(""),V&&_();try{const s=await oe(e,l);let r="",m=i;if(c){const v=I.find(h=>h.id===c);v&&(m=`TEMPLATE:${v.prompt}`)}if(s.trim())r=await te(s,m,l),u(r);else if(e.type==="application/pdf"){const h={inlineData:{data:await new Promise((d,k)=>{const p=new FileReader;p.readAsDataURL(e),p.onload=()=>d(p.result.split(",")[1]),p.onerror=j=>k(j)}),mimeType:"application/pdf"}};try{l("جاري محاولة تحليل الملف مباشرة..."),r=await ee(h,m),u(r)}catch(d){if(d.message.includes("لا يدعم تحليل ملفات PDF مباشرة")){E({file:e,summaryType:m}),P(!0),g(!1);return}throw d}}else throw new Error("لم يتمكن من استخراج النص من المستند، قد يكون ملفًا قائمًا على الصور أو فارغًا. هذه الميزة تدعم حاليًا ملفات PDF المصورة فقط.");T("✅ اكتمل تلخيص المستند!",{body:`تم تلخيص ملفك "${e.name}" بنجاح.`})}catch(s){s instanceof H?z({serviceId:"summarize",resume:r=>X(r.file,r.summaryType),context:{file:e,summaryType:i}}):(n(s.message||"حدث خطأ غير متوقع. قد يكون الملف فارغًا أو محميًا بكلمة مرور."),w(null),T("❌ فشل تلخيص المستند",{body:`حدث خطأ أثناء تلخيص ملفك "${e.name}".`}))}finally{M||(g(!1),l(""))}},J=()=>{o&&X(o,x)},O=e=>{if(e.length>0){const i=e[0];["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain"].includes(i.type)?(w(i),u(""),n("")):n("نوع الملف غير مدعوم. الرجاء اختيار PDF, DOCX, أو TXT.")}},K=()=>{w(null),u(""),n(""),l(""),y("points"),b("")};if(C&&o){const e=[{type:"paragraph",content:C}];return t.jsx(re,{title:`ملخص لـ: ${o.name}`,onReset:K,canSaveToLibrary:!0,structuredContent:e,fileName:`ملخص - ${o.name}`,fileType:o.type,documentType:"summary",sourceFileName:o.name,children:t.jsx("div",{className:"prose prose-slate dark:prose-invert max-w-none text-right",dangerouslySetInnerHTML:{__html:C.replace(/\n/g,"<br />")}})})}return t.jsxs("div",{className:"max-w-3xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg",children:[t.jsx("canvas",{ref:N,className:"hidden"}),t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx(se,{onFileSelect:O,acceptedFileTypes:".pdf,.docx,.txt",promptText:o?o.name:"اسحب وأفلت ملف (PDF, DOCX, TXT) هنا أو انقر للاختيار"}),t.jsx("div",{className:"mt-6 w-full",children:t.jsxs("fieldset",{children:[t.jsx("legend",{className:"text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3 text-center",children:"اختر أسلوب التلخيص"}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-center mb-4",children:[t.jsxs("div",{children:[t.jsx("input",{type:"radio",id:"type-points",name:"summaryType",value:"points",checked:x==="points"&&!c,onChange:e=>{y(e.target.value),b("")},className:"sr-only"}),t.jsx("label",{htmlFor:"type-points",className:"block p-3 border-2 rounded-lg cursor-pointer transition-colors border-slate-300 dark:border-slate-600 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 has-[:checked]:bg-blue-100 dark:has-[:checked]:bg-blue-900/50 has-[:checked]:border-blue-600 font-semibold",children:"نقاط رئيسية"})]}),t.jsxs("div",{children:[t.jsx("input",{type:"radio",id:"type-short",name:"summaryType",value:"short",checked:x==="short"&&!c,onChange:e=>{y(e.target.value),b("")},className:"sr-only"}),t.jsx("label",{htmlFor:"type-short",className:"block p-3 border-2 rounded-lg cursor-pointer transition-colors border-slate-300 dark:border-slate-600 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 has-[:checked]:bg-blue-100 dark:has-[:checked]:bg-blue-900/50 has-[:checked]:border-blue-600 font-semibold",children:"ملخص قصير"})]}),t.jsxs("div",{children:[t.jsx("input",{type:"radio",id:"type-detailed",name:"summaryType",value:"detailed",checked:x==="detailed"&&!c,onChange:e=>{y(e.target.value),b("")},className:"sr-only"}),t.jsx("label",{htmlFor:"type-detailed",className:"block p-3 border-2 rounded-lg cursor-pointer transition-colors border-slate-300 dark:border-slate-600 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 has-[:checked]:bg-blue-100 dark:has-[:checked]:bg-blue-900/50 has-[:checked]:border-blue-600 font-semibold",children:"ملخص مفصل"})]}),t.jsxs("div",{children:[t.jsx("input",{type:"radio",id:"type-simple",name:"summaryType",value:"simple",checked:x==="simple"&&!c,onChange:e=>{y(e.target.value),b("")},className:"sr-only"}),t.jsx("label",{htmlFor:"type-simple",className:"block p-3 border-2 rounded-lg cursor-pointer transition-colors border-slate-300 dark:border-slate-600 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 has-[:checked]:bg-blue-100 dark:has-[:checked]:bg-blue-900/50 has-[:checked]:border-blue-600 font-semibold",children:"شرح مبسط"})]})]}),I.length>0&&t.jsxs("div",{className:"mt-2",children:[t.jsx("label",{htmlFor:"template-select",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"أو اختر قالباً مخصصاً:"}),t.jsxs("select",{id:"template-select",value:c,onChange:e=>b(e.target.value),className:"w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800",children:[t.jsx("option",{value:"",children:"-- اختر من القوالب --"}),I.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]})]})}),t.jsx("button",{id:"primary-action-button",title:"Cmd/Ctrl + Enter",onClick:J,disabled:S||!o,className:"mt-6 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center w-48",children:S?t.jsx(Z,{}):"تلخيص الآن"}),S&&$&&t.jsx("p",{role:"status",className:"mt-4 text-slate-600 dark:text-slate-300 text-center",children:$}),R&&t.jsx("p",{role:"alert",className:"mt-4 text-red-500 bg-red-100 dark:bg-red-900/50 dark:text-red-300 p-3 rounded-md w-full text-center",children:R})]}),t.jsx(le,{isOpen:M,title:"المزود لا يدعم الملف",message:`مزود الخدمة المحدد لا يدعم تحليل ملفات PDF مباشرة. 

هل تود المتابعة عن طريق تحويل صفحات الملف إلى صور وتلخيصها؟`,onConfirm:G,onCancel:()=>{P(!1),E(null)},confirmText:"نعم، حول إلى صور",cancelText:"إلغاء"})]})};export{ve as default};
