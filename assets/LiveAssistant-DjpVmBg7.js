import{r as c,j as e,a as U}from"./index-BTUQfSWa.js";import{a as K,G as _,M as V}from"./settingsService-p0j8CqeW.js";import{F as z}from"./FileUpload-CeNdxQgG.js";import{e as W}from"./textExtractorService-Dks41_ry.js";import"https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs";var Y={};const J=()=>{const[h,S]=c.useState(null),[k,p]=c.useState(!1),[R,w]=c.useState(!1),[F,f]=c.useState("جاهز"),[C,x]=c.useState(""),[j,I]=c.useState(""),b=c.useRef(null),v=c.useRef(null),A=c.useRef(null),m=c.useRef(0),y=c.useRef(new Set),L=async s=>{if(s.length>0){const o=s[0];S(o),p(!0),f("جاري استخراج محتوى الملف...");try{const n=await W(o,t=>f(t));I(n),f("تم تحميل الملف. يمكنك بدء المحادثة الآن.")}catch(n){x(n.message),S(null)}finally{p(!1)}}},M=async()=>{const s=K(),o=s.googleApiKey||Y.API_KEY;if(!o){x("مفتاح Google API غير موجود في الإعدادات.");return}if(s.provider!=="google"){x("هذه الميزة متاحة فقط مع مزود Google حالياً.");return}p(!0),x("");try{const n=new _({apiKey:o});b.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3}),v.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});const t=await navigator.mediaDevices.getUserMedia({audio:!0}),l={responseModalities:[V.AUDIO],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:"Zephyr"}}},systemInstruction:`You are a helpful document assistant interacting in Arabic.
            The user has uploaded a document with the following content:
            ---
            ${j?j.substring(0,2e4):"No document provided yet."}
            ---
            Answer questions based on this document. Keep responses concise and natural for voice.`},g=n.live.connect({model:"gemini-2.5-flash-native-audio-preview-09-2025",callbacks:{onopen:()=>{f("متصل. تحدث الآن!"),w(!0),p(!1);const i=b.current;if(!i)return;const r=i.createMediaStreamSource(t),d=i.createScriptProcessor(4096,1,1);d.onaudioprocess=a=>{const u=a.inputBuffer.getChannelData(0),G=T(u);g.then(P=>{P.sendRealtimeInput({media:G})})},r.connect(d),d.connect(i.destination)},onmessage:async i=>{const r=v.current;if(!r)return;const d=i.serverContent?.modelTurn?.parts[0]?.inlineData?.data;if(d){m.current<r.currentTime&&(m.current=r.currentTime);try{const a=await E(D(d),r,24e3,1),u=r.createBufferSource();u.buffer=a,u.connect(r.destination),u.addEventListener("ended",()=>{y.current.delete(u)}),u.start(m.current),m.current+=a.duration,y.current.add(u)}catch(a){console.error("Error decoding audio",a)}}if(i.serverContent?.interrupted){for(const a of y.current.values())a.stop();y.current.clear(),m.current=0}},onclose:()=>{f("انتهت الجلسة"),w(!1)},onerror:i=>{console.error(i),x("حدث خطأ في الاتصال"),w(!1)}},config:l});A.current=g}catch(n){x(n.message||"فشل بدء الجلسة الصوتية"),p(!1)}},N=async()=>{A.current&&(await A.current).close(),b.current&&b.current.close(),v.current&&v.current.close(),w(!1),f("تم قطع الاتصال")};function T(s){const o=s.length,n=new Int16Array(o);for(let t=0;t<o;t++)n[t]=s[t]*32768;return{data:B(new Uint8Array(n.buffer)),mimeType:"audio/pcm;rate=16000"}}function B(s){let o="";const n=s.byteLength;for(let t=0;t<n;t++)o+=String.fromCharCode(s[t]);return btoa(o)}function D(s){const o=atob(s),n=o.length,t=new Uint8Array(n);for(let l=0;l<n;l++)t[l]=o.charCodeAt(l);return t}async function E(s,o,n,t){const l=new Int16Array(s.buffer),g=l.length/t,i=o.createBuffer(t,g,n);for(let r=0;r<t;r++){const d=i.getChannelData(r);for(let a=0;a<g;a++)d[a]=l[a*t+r]/32768}return i}return c.useEffect(()=>()=>{N()},[]),e.jsxs("div",{className:"max-w-3xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg text-center",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"w-24 h-24 mx-auto bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 mb-4",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"}),e.jsx("path",{d:"M19 10v2a7 7 0 0 1-14 0v-2"}),e.jsx("line",{x1:"12",y1:"19",x2:"12",y2:"23"}),e.jsx("line",{x1:"8",y1:"23",x2:"16",y2:"23"})]})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-800 dark:text-slate-100",children:"المساعد الصوتي المباشر"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 mt-2",children:"تحدث مع مستنداتك بشكل طبيعي"})]}),!h&&e.jsx("div",{className:"mb-6",children:e.jsx(z,{onFileSelect:L,acceptedFileTypes:".pdf,.docx,.txt",promptText:"اختر مستنداً للتحدث معه"})}),h&&e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg mb-6",children:[e.jsx("p",{className:"font-semibold text-slate-700 dark:text-slate-200",children:h.name}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:F})]}),h&&e.jsx("div",{className:"flex justify-center gap-4",children:R?e.jsx("button",{onClick:N,className:"bg-red-600 text-white font-bold py-4 px-10 rounded-full hover:bg-red-700 transition-all shadow-lg animate-pulse",children:"إنهاء المحادثة"}):e.jsx("button",{onClick:M,disabled:k||!j,className:"bg-indigo-600 text-white font-bold py-4 px-10 rounded-full hover:bg-indigo-700 transition-all shadow-lg flex items-center gap-2 disabled:bg-slate-400 disabled:cursor-not-allowed",children:k?e.jsx(U,{}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"}),e.jsx("path",{d:"M19 10v2a7 7 0 0 1-14 0v-2"}),e.jsx("line",{x1:"12",y1:"19",x2:"12",y2:"23"}),e.jsx("line",{x1:"8",y1:"23",x2:"16",y2:"23"})]}),"بدء المحادثة"]})})}),C&&e.jsx("p",{className:"mt-4 text-red-500 bg-red-100 dark:bg-red-900/50 p-3 rounded",children:C})]})};export{J as default};
