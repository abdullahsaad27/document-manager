import{j as e,r as a,u as P,a as C}from"./index-BTUQfSWa.js";import{F as V}from"./FileUpload-CeNdxQgG.js";import{i as D,j as H,A as M}from"./aiService-0OA8UE0R.js";import"https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs";import"./settingsService-p0j8CqeW.js";const J=({sheet:p,onFormulaClick:k})=>{if(!p||!p["!ref"])return e.jsx("div",{className:"p-4 text-center",children:"لا توجد بيانات لعرضها."});const c=XLSX.utils.decode_range(p["!ref"]),l=[];for(let r=c.s.r;r<=c.e.r;++r){const o=[];for(let n=c.s.c;n<=c.e.c;++n){const d={c:n,r},x=XLSX.utils.encode_cell(d),F=p[x];o.push(F)}l.push(o)}const g=l.length>0?l[0]:[],i=l.length>1?l.slice(1):g.some(r=>r)?[]:[g];return e.jsx("div",{className:"overflow-auto border dark:border-slate-700 rounded-lg max-h-[70vh] bg-white dark:bg-slate-800",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-200 dark:divide-slate-700 text-right",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-slate-700 sticky top-0 z-10",children:e.jsx("tr",{children:g.map((r,o)=>e.jsx("th",{scope:"col",className:"px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider",children:r?XLSX.utils.format_cell(r):""},o))})}),e.jsx("tbody",{className:"bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700",children:i.map((r,o)=>e.jsx("tr",{className:"hover:bg-slate-50 dark:hover:bg-slate-700/50",children:r.map((n,d)=>e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-800 dark:text-slate-200",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[n?XLSX.utils.format_cell(n):"",n&&n.f&&e.jsx("button",{onClick:()=>k(n.f),title:"شرح هذه الصيغة",className:"text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14.7 14.7 9 20l-4-4 5.7-5.7"}),e.jsx("path",{d:"m14.5 5.5 5.5 5.5"}),e.jsx("path",{d:"M12 22h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v8"})]})})]})},d))},o))})]})})},Q=({onSelectService:p})=>{const[k,c]=a.useState(null),[l,g]=a.useState(null),[i,r]=a.useState(0),[o,n]=a.useState(!1),[d,x]=a.useState(""),[F,T]=a.useState(null);a.useRef(null);const[f,j]=a.useState([]),[b,w]=a.useState(""),[E,A]=a.useState(!1),[I,N]=a.useState(null),[_,y]=a.useState(""),[W,R]=a.useState(!1),S=a.useRef(null),L=a.useRef(null),{setInterruptedTask:B}=P();a.useEffect(()=>{const t=f[f.length-1];if(t?.role==="assistant"&&t.chart&&S.current){L.current&&L.current.destroy();const s=S.current.getContext("2d");s&&(L.current=new Chart(s,t.chart))}},[f]);const U=t=>{const s=t[0];s&&(["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(s.type)?(c(s),x(""),T(null),r(0),j([]),w(""),$(s)):x("الرجاء اختيار ملف Excel (XLSX, XLS) فقط."))},$=t=>{n(!0);const s=new FileReader;s.onload=h=>{try{const u=new Uint8Array(h.target?.result),m=XLSX.read(u,{type:"array"});g(m)}catch{x("فشل في قراءة ملف Excel. قد يكون الملف تالفًا.")}finally{n(!1)}},s.onerror=()=>{x("فشل في قراءة الملف."),n(!1)},s.readAsArrayBuffer(t)},X=async()=>{if(!b.trim()||!l)return;const t=[...f,{role:"user",content:b}];j(t),w(""),A(!0);try{const s=l.Sheets[l.SheetNames[i]],h=XLSX.utils.sheet_to_csv(s),u=await H(h,b);let m;try{const v=JSON.parse(u);v.type&&v.data?m={role:"assistant",content:"لقد قمت بإنشاء الرسم البياني الذي طلبته.",chart:v}:m={role:"assistant",content:u}}catch{m={role:"assistant",content:u}}j([...t,m])}catch(s){const h=s instanceof M?"تم الوصول إلى حد الاستخدام. يرجى التحقق من إعداداتك.":"حدث خطأ أثناء تحليل البيانات.";j([...t,{role:"assistant",content:h}]),s instanceof M&&B({serviceId:"excel-tools",resume:X,context:{}})}finally{A(!1)}},z=async t=>{N(t),R(!0),y("");try{const s=await D(t);y(s)}catch{y("فشل في شرح الصيغة.")}finally{R(!1)}};return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[l?e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 flex-wrap gap-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-slate-100 truncate",children:k?.name}),e.jsx("div",{role:"tablist","aria-label":"أوراق العمل",className:"bg-slate-100 dark:bg-slate-700 p-1 rounded-lg flex gap-1 flex-wrap",children:l.SheetNames.map((t,s)=>e.jsx("button",{onClick:()=>r(s),role:"tab","aria-selected":i===s,"aria-controls":"sheet-panel",className:`px-3 py-1 text-sm font-semibold rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 ${i===s?"bg-white dark:bg-slate-600 shadow":"hover:bg-slate-200 dark:hover:bg-slate-600"}`,children:t},t))})]}),e.jsx("div",{role:"tabpanel",id:"sheet-panel",children:e.jsx(J,{sheet:l.Sheets[l.SheetNames[i]],onFormulaClick:z})})]}),e.jsxs("div",{className:"lg:col-span-1 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col h-[80vh]",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-800 dark:text-slate-100 mb-4 border-b dark:border-slate-700 pb-2",children:"محلل البيانات AI"}),e.jsxs("div",{className:"flex-1 overflow-y-auto pr-2 space-y-4",children:[f.map((t,s)=>e.jsx("div",{className:`flex flex-col ${t.role==="user"?"items-end":"items-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-sm p-3 rounded-lg ${t.role==="user"?"bg-blue-500 text-white":"bg-slate-100 dark:bg-slate-700"}`,children:[e.jsx("p",{className:"text-sm",children:t.content}),t.chart&&e.jsx("div",{className:"mt-2 bg-white p-2 rounded",children:e.jsx("canvas",{ref:S,width:"400",height:"300"})})]})},s)),E&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-slate-700",children:e.jsx(C,{})})})]}),e.jsx("div",{className:"mt-4 pt-4 border-t dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:b,onChange:t=>w(t.target.value),onKeyPress:t=>t.key==="Enter"&&X(),placeholder:"اسأل عن بياناتك...",className:"w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-700"}),e.jsx("button",{id:"primary-action-button",onClick:X,disabled:E||!b,className:"bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 disabled:bg-slate-400",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"m22 2-7 20-4-9-9-4Z"}),e.jsx("path",{d:"M22 2 11 13"})]})})]})})]})]}):e.jsx("div",{className:"bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg max-w-3xl mx-auto",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(V,{onFileSelect:U,acceptedFileTypes:".xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",promptText:"اسحب وأفلت ملف Excel (XLSX) هنا أو انقر للاختيار"}),o&&e.jsx("div",{className:"mt-4",children:e.jsx(C,{})})]})}),d&&e.jsx("p",{role:"alert",className:"mt-4 text-red-500 bg-red-100 dark:bg-red-900/50 dark:text-red-300 p-3 rounded-md w-full text-center",children:d}),I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center",onClick:()=>N(null),children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-slate-100 mb-2",children:"شرح الصيغة"}),e.jsx("p",{className:"font-mono text-sm p-2 bg-slate-100 dark:bg-slate-700 rounded mb-4 text-left",dir:"ltr",children:I}),W?e.jsx(C,{}):e.jsx("p",{className:"text-slate-600 dark:text-slate-300 whitespace-pre-wrap",children:_}),e.jsx("button",{onClick:()=>N(null),className:"mt-4 w-full bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-100 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500",children:"إغلاق"})]})})]})};export{Q as default};
